# –°–µ—Ä–≤–∏—Å: Bot Gateway

–≠—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —à–ª—é–∑ –¥–ª—è Telegram-–±–æ—Ç–∞, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –Ω–∞ FastAPI. –û–Ω –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–µ–±—Ö—É–∫–∏ –æ—Ç Telegram, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏—Ö —Å –ø–æ–º–æ—â—å—é aiogram –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –¥—Ä—É–≥–∏–º–∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏ —á–µ—Ä–µ–∑ gRPC –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é Consul. –í –∫–∞—á–µ—Å—Ç–≤–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Nginx –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏—è SSL –∏ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

-   `.`
    -   `docker-compose.yml`: –§–∞–π–ª –¥–ª—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ —Å –ø–æ–º–æ—â—å—é Docker Compose.
    -   `nginx/`: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ Nginx.
    -   `bot_gateway/`: –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Å–µ—Ä–≤–∏—Å–∞ `bot_gateway`.
        -   `Dockerfile`: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Å–±–æ—Ä–∫–∏ Docker-–æ–±—Ä–∞–∑–∞ —Å–µ—Ä–≤–∏—Å–∞.
        -   `pyproject.toml`: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è Poetry.
        -   `src/bot_gateway/`: –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–¥–æ–≤–∞—è –±–∞–∑–∞.
            -   `api/`: –ú–æ–¥—É–ª–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å FastAPI –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤.
            -   `bot/`: –õ–æ–≥–∏–∫–∞ —Å–∞–º–æ–≥–æ Telegram-–±–æ—Ç–∞ (—Ö–µ–Ω–¥–ª–µ—Ä—ã –∏ —Ç.–¥.).
            -   `core/`: –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è.
            -   `grpc_clients/`: –ö–ª–∏–µ–Ω—Ç—ã –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ –ø–æ gRPC.
            -   `main.py`: –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ FastAPI.
        -   `tests/`: –¢–µ—Å—Ç—ã –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

-   **Python 3.10**
-   **FastAPI**: –í–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è API.
-   **Aiogram 3**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Telegram-–±–æ—Ç–æ–≤.
-   **gRPC**: –§—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä.
-   **Consul**: –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ (service discovery).
-   **Docker & Docker Compose**: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è –∏ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è.
-   **Nginx**: –í–µ–±-—Å–µ—Ä–≤–µ—Ä –∏ –æ–±—Ä–∞—Ç–Ω—ã–π –ø—Ä–æ–∫—Å–∏.
-   **Poetry**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏.

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫

1.  **–ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:**
    ```bash
    git clone <your-repo-url>
    cd <your-repo-name>
    ```

2.  **–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
    –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ –Ω–µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
    ```env
    TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here
    WEBHOOK_HOST=https://your_domain.com
    ```
    -   `TELEGRAM_BOT_TOKEN`: –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram-–±–æ—Ç–∞.
    -   `WEBHOOK_HOST`: –í–∞—à –¥–æ–º–µ–Ω, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π Telegram –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

3.  **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Nginx –∏ SSL:**
    -   –í —Ñ–∞–π–ª–µ `nginx/nginx.conf` –∑–∞–º–µ–Ω–∏—Ç–µ `your_domain.com` –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω.
    -   –î–ª—è —Ä–∞–±–æ—Ç—ã HTTPS –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã. `docker-compose.yml` –æ–∂–∏–¥–∞–µ—Ç, —á—Ç–æ –æ–Ω–∏ –±—É–¥—É—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ `/etc/letsencrypt`. –í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –∏—Ö —Å –ø–æ–º–æ—â—å—é Certbot.
    -   –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å `server` –±–ª–æ–∫ –¥–ª—è 443 –ø–æ—Ä—Ç–∞ –≤ `nginx.conf`, –∑–∞–ø—É—Å—Ç–∏—Ç—å Nginx, –ø–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Å –ø–æ–º–æ—â—å—é Certbot, –∞ –∑–∞—Ç–µ–º —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Nginx.

4.  **–°–∫–æ–º–ø–∏–ª–∏—Ä—É–π—Ç–µ Protobuf-—Ñ–∞–π–ª—ã (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è):**
    –ï—Å–ª–∏ –≤—ã –≤–Ω–æ—Å–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `.proto` —Ñ–∞–π–ª—ã, –≤–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å gRPC-–∫–æ–¥.
    ```bash
    python -m grpc_tools.protoc -I./bot_gateway/src/bot_gateway/grpc_clients/protos --python_out=./bot_gateway/src/bot_gateway/grpc_clients/protos --pyi_out=./bot_gateway/src/bot_gateway/grpc_clients/protos --grpc_python_out=./bot_gateway/src/bot_gateway/grpc_clients/protos ./bot_gateway/src/bot_gateway/grpc_clients/protos/auth.proto
    ```

5.  **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã:**
    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Docker Compose –¥–ª—è —Å–±–æ—Ä–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤.
    ```bash
    docker-compose up --build -d
    ```
    –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ `bot_gateway` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –≤–µ–±—Ö—É–∫ –¥–ª—è Telegram –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.

## API

### Webhook

-   **URL**: `/api/v1/{TELEGRAM_BOT_TOKEN}`
-   **Method**: `POST`
-   **–û–ø–∏—Å–∞–Ω–∏–µ**: –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–∏–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram. URL –∑–∞—â–∏—â–µ–Ω —Å–µ–∫—Ä–µ—Ç–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `X-Telegram-Bot-Api-Secret-Token`.

## –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

### Auth Service (gRPC)

–°–µ—Ä–≤–∏—Å `bot_gateway` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç gRPC –¥–ª—è —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–∏—Å–æ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (`auth_service`).

-   **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ**: –ê–¥—Ä–µ—Å `auth_service` –ø–æ–ª—É—á–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ Consul.
-   **–ú–µ—Ç–æ–¥—ã**:
    -   `GetUser(user_id)`: –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø–æ –µ–≥–æ Telegram ID.

```

# ---------------- END README.md----------------
# ---------------- START structure.mermaid----------------
```mermaid
graph TD
    subgraph "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç"
        User(üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
        Telegram[üåç Telegram API]
    end

    subgraph "–í–∞—à–∞ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (Docker)"
        Nginx(üåê Nginx)

        subgraph "Service: bot_gateway"
            FastAPI(üöÄ FastAPI)
            Aiogram(ü§ñ Aiogram)
            gRPC_Client(üîå gRPC Client)
        end

        Consul(üìç Consul)

        subgraph "Service: auth_service (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π)"
            AuthService(üîí gRPC Auth Service)
        end

    end

    User -- "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /start" --> Telegram
    Telegram -- "POST Webhook" --> Nginx
    Nginx -- "proxy_pass http://bot_gateway:8000" --> FastAPI

    FastAPI -- "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å" --> Aiogram
    Aiogram -- "–í—ã–∑—ã–≤–∞–µ—Ç —Ö–µ–Ω–¥–ª–µ—Ä" --> gRPC_Client

    gRPC_Client -- "1. –ó–∞–ø—Ä–æ—Å –∞–¥—Ä–µ—Å–∞ auth_service" --> Consul
    Consul -- "2. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–¥—Ä–µ—Å" --> gRPC_Client
    gRPC_Client -- "3. gRPC –≤—ã–∑–æ–≤ GetUser(id)" --> AuthService
    AuthService -- "4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" --> gRPC_Client
    
    gRPC_Client -- "–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ö–µ–Ω–¥–ª–µ—Ä—É" --> Aiogram
    Aiogram -- "–§–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç" --> FastAPI
    FastAPI -- "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç –≤ Telegram" --> Telegram
    Telegram -- "–î–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ" --> User

    %% Dependencies
    Nginx --> bot_gateway
    bot_gateway --> Consul
    auth_service -.-> Consul